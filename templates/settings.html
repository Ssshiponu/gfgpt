<!-- Settings Component -->
<div x-data="settings()" x-show="step === 4" class="p-8 bg-white overflow-y-auto">
    <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Settings</h2>
    
    <!-- Error Message -->
    <div x-show="error" style="display: none;" x-transition class="text-red-600 text-sm m-2 py-2 px-4 bg-red-100 border border-dashed border-red-600 rounded-lg">
        <p x-text="error"></p>
    </div>

    <div x-effect="xEffect()" class="w-full border-gray-200 mb-8">
        <!-- Language Selection -->
        <div class="settings w-full py-3 flex items-center justify-between border-b">
            <label for="language" class="text-gray-600 font-medium">Language</label>
            <select id="language" name="language" x-model="language"
                class="px-4 py-2 bg-white rounded-lg focus:outline-none focus:bg-gray-100 transition-all duration-200 text-gray-600"
                :disabled="loading">
                {% for lang in languages %}
                    <option value="{{ lang }}" {% if lang == settings.language %}selected{% endif %}>{{ lang }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Use Emojis -->
        <div class="settings w-full py-3 flex items-center justify-between border-b">
            <label for="use_emojis" class="text-gray-600 font-medium">Use Emojis</label>
            <select id="use_emojis" name="use_emojis" x-model="use_emojis"
                class="px-4 py-2 bg-white rounded-lg focus:outline-none focus:bg-gray-100 transition-all duration-200 text-gray-600"
                :disabled="loading">
                {% for e in use_emojis %}
                    <option value="{{ e }}" {% if e == settings.use_emojis %}selected{% endif %}>{{ e }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Pronoun -->
        <div class="settings w-full py-3 flex items-center justify-between border-b">
            <label for="pronoun" class="text-gray-600 font-medium">Pronoun</label>
            <select id="pronoun" name="pronoun" x-model="pronoun"
                class="px-4 py-2 bg-white rounded-lg focus:outline-none focus:bg-gray-100 transition-all duration-200 text-gray-600"
                :disabled="loading">
                <template x-for="p in pronouns[language] || []" :key="p">
                    <option :value="p" x-text="p" :selected="p == '{{ settings.pronoun }}'"></option>
                </template>
            </select>
        </div>

        <!-- Personality -->
        <div class="settings w-full py-3 flex items-center justify-between border-b">
            <label for="personality" class="text-gray-600 font-medium">Personality</label>
            <select id="personality" name="personality" x-model="personality"
                class="px-4 py-2 bg-white rounded-lg focus:outline-none focus:bg-gray-100 transition-all duration-200 text-gray-600"
                :disabled="loading">
                {% for personality in personalities %}
                    <option value="{{ personality }}" {% if personality == settings.personality %}selected{% endif %}>{{ personality }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Tone -->
        <div class="settings w-full py-3 flex items-center justify-between">
            <label for="tone" class="text-gray-600 font-medium">Tone</label>
            <select id="tone" name="tone" x-model="tone"
                class="px-4 py-2 bg-white rounded-lg focus:outline-none focus:bg-gray-100 transition-all duration-200 text-gray-600"
                :disabled="loading">
                {% for tone in tones %}
                    <option value="{{ tone }}" {% if tone == settings.tone %}selected{% endif %}>{{ tone }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center justify-end gap-2 md:gap-4">
        <button type="button" @click="showModal = false" 
            class="py-2 px-3 md:px-5 rounded font-semibold text-sm transition-colors duration-200 bg-gray-200 hover:bg-gray-300 text-gray-800 disabled:opacity-50"
            :disabled="loading">
            Cancel
        </button>
        <button @click="formAction='reset'; submitSettingsForm()" 
            class="py-2 px-3 md:px-5 rounded font-semibold text-sm transition-colors duration-200 bg-gray-200 hover:bg-gray-300 text-gray-800 disabled:opacity-50"
            :disabled="loading">
            Default
        </button>
        <button @click="submitSettingsForm()"
            class="py-2 px-3 md:px-5 rounded font-semibold text-sm transition-colors duration-200 bg-green-500 hover:bg-green-600 text-white disabled:opacity-50 disabled:cursor-not-allowed"
            :disabled="loading">
            <span x-show="!loading">Save</span>
            <span x-show="loading">Saving...</span>
        </button>
    </div>
</div>

<script>
    function settings() {
        return {
            pronouns: {{ pronouns|safe }},
            formAction: 'update',
            language: '{{ settings.language }}',
            use_emojis: '{{ settings.use_emojis }}',
            pronoun: '{{ settings.pronoun }}',
            personality: '{{ settings.personality }}',
            tone: '{{ settings.tone }}',
            error: '',
            loading: false,
            
            submitSettingsForm() {
                // Clear previous error and set loading state
                this.error = '';
                this.loading = true;
                
                // Basic validation
                if (!this.language || !this.pronoun || !this.personality || !this.tone) {
                    this.error = 'Please fill in all required fields.';
                    this.loading = false;
                    return;
                }
                
                fetch('{% url "settings" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({
                        formAction: this.formAction,
                        language: this.language,
                        use_emojis: this.use_emojis,
                        pronoun: this.pronoun,
                        personality: this.personality,
                        tone: this.tone,
                    }),
                })
                .then(async (response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (data.status === 'ok') {
                        this.error = '';
                        this.showModal = false;
                    } else {
                        this.error = data.message || 'Error. Please try again.';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.error = 'Error. Please try again.';
                })
                .finally(() => {
                    this.loading = false;
                    // Reset form action after submission
                    this.formAction = 'update';
                });
            },

            xEffect() {
                // This will auto-update pronoun if not valid for the new language
                if (this.pronouns[this.language] && !this.pronouns[this.language].includes(this.pronoun)) {
                    this.pronoun = this.pronouns[this.language][0];
                }
            },
        }
    }
</script>